{% extends "base.html" %}
{% from "macros/components.html" import stats_grid, filter_select, bar_chart, metric_rows, dashboard_card %}

{% block title %}Dosing Reports - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dosing Verification Analytics</h1>
    <p class="subtitle">Performance Metrics & Trends</p>
</div>

<!-- Sub-navigation -->
<div class="module-nav">
    <a href="{{ url_for('dosing_verification.active') }}" class="module-nav-link">Dashboard</a>
    <a href="{{ url_for('dosing_verification.active') }}" class="module-nav-link">Active</a>
    <a href="{{ url_for('dosing_verification.history') }}" class="module-nav-link">History</a>
    <a href="{{ url_for('dosing_verification.reports') }}" class="module-nav-link active">Reports</a>
    <a href="{{ url_for('dosing_verification.help_page') }}" class="module-nav-link">Help</a>
    <a href="{{ url_for('main.landing') }}" class="module-nav-link">Main</a>
</div>

<!-- Period Filter -->
<div class="filters">
    <form method="get" class="filter-form">
        {{ filter_select(
            name="days",
            label="Period",
            options=[("7", "Last 7 days"), ("14", "Last 14 days"), ("30", "Last 30 days"), ("60", "Last 60 days"), ("90", "Last 90 days")],
            current=days|string
        ) }}
    </form>
</div>

<!-- Summary Stats -->
{{ stats_grid([
    {"value": analytics.total_alerts or 0, "label": "Total Alerts", "sublabel": "Last " ~ days ~ " days"},
    {"value": (analytics.resolution_rate|round(1)|string ~ "%") if analytics.resolution_rate is not none else "--", "label": "Resolution Rate", "sublabel": "Alerts resolved", "variant": "success"},
    {"value": analytics.avg_time_to_resolution or "--", "label": "Avg Response Time", "sublabel": "Time to resolution", "variant": "info"},
    {"value": analytics.most_common_flag or "â€”", "label": "Top Flag Type", "sublabel": "Most frequent issue"}
]) }}

<!-- Alert Volume by Severity (30-day trend) -->
{% call dashboard_card("Alert Volume by Severity", "Daily trend over " ~ days ~ " days") %}
    {% if analytics.volume_by_day %}
    <div class="chart-wrapper">
        <canvas id="volumeChart" width="400" height="200"></canvas>
    </div>
    <script>
    // Simple line chart using Canvas API
    const canvas = document.getElementById('volumeChart');
    const ctx = canvas.getContext('2d');
    const data = {{ analytics.volume_by_day | tojson }};

    // Chart dimensions
    const padding = 40;
    const width = canvas.width - 2 * padding;
    const height = canvas.height - 2 * padding;

    // Find max value for scaling
    const maxVal = Math.max(...data.map(d => d.critical + d.high + d.moderate), 1);

    // Draw axes
    ctx.strokeStyle = '#dee2e6';
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height + padding);
    ctx.lineTo(width + padding, height + padding);
    ctx.stroke();

    // Draw bars
    const barWidth = width / data.length - 2;
    data.forEach((d, i) => {
        const x = padding + (width / data.length) * i + 1;
        const total = d.critical + d.high + d.moderate;
        const barHeight = (total / maxVal) * height;

        // Critical (red)
        ctx.fillStyle = '#dc3545';
        const criticalHeight = (d.critical / maxVal) * height;
        ctx.fillRect(x, height + padding - criticalHeight, barWidth, criticalHeight);

        // High (amber)
        ctx.fillStyle = '#ffc107';
        const highHeight = (d.high / maxVal) * height;
        ctx.fillRect(x, height + padding - criticalHeight - highHeight, barWidth, highHeight);

        // Moderate (blue)
        ctx.fillStyle = '#17a2b8';
        const modHeight = (d.moderate / maxVal) * height;
        ctx.fillRect(x, height + padding - criticalHeight - highHeight - modHeight, barWidth, modHeight);
    });

    // Draw labels (every 3rd day)
    ctx.fillStyle = '#6c757d';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    data.forEach((d, i) => {
        if (i % 3 === 0) {
            const x = padding + (width / data.length) * i + barWidth / 2;
            ctx.fillText(d.date.slice(5), x, height + padding + 15);
        }
    });
    </script>
    {% else %}
    <p class="text-muted">No volume data available.</p>
    {% endif %}
{% endcall %}

<!-- Top Flagged Drugs -->
{% call dashboard_card("Top Flagged Drugs", "Most frequently flagged antimicrobials") %}
    {% if analytics.top_drugs %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Drug</th>
                <th>Alerts</th>
                <th>Most Common Issue</th>
            </tr>
        </thead>
        <tbody>
            {% for drug in analytics.top_drugs %}
            <tr>
                <td><strong>{{ drug.drug }}</strong></td>
                <td>{{ drug.count }}</td>
                <td>{{ drug.most_common_flag | replace('_', ' ') | title }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No data available.</p>
    {% endif %}
{% endcall %}

<!-- Top Flag Types -->
{% call dashboard_card("Top Flag Types", "Most common dosing issues") %}
    {% if analytics.top_flags %}
    {% set flag_items = [] %}
    {% for flag in analytics.top_flags %}
        {% set _ = flag_items.append({"label": flag.flag_type | replace('_', ' ') | title, "value": flag.count}) %}
    {% endfor %}
    {{ bar_chart(
        items=flag_items,
        bar_class="bar-warning"
    ) }}
    {% else %}
    <p class="text-muted">No data available.</p>
    {% endif %}
{% endcall %}

<!-- Resolution Breakdown -->
{% call dashboard_card("Resolution Breakdown", "How alerts were resolved") %}
    {% if analytics.resolution_breakdown %}
    <div class="resolution-grid">
        {% for res in analytics.resolution_breakdown %}
        <div class="resolution-item">
            <div class="resolution-count">{{ res.count }}</div>
            <div class="resolution-label">{{ res.resolution | replace('_', ' ') | title }}</div>
            <div class="resolution-percent">{{ res.percentage }}%</div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No resolution data available.</p>
    {% endif %}
{% endcall %}

<!-- Acceptance Rate (% where dose was changed) -->
{% call dashboard_card("Clinical Impact", "Alerts resulting in therapy changes") %}
    {{ metric_rows([
        {"label": "Dose Adjusted", "value": analytics.dose_adjusted_count or 0},
        {"label": "Interval Adjusted", "value": analytics.interval_adjusted_count or 0},
        {"label": "Route Changed", "value": analytics.route_changed_count or 0},
        {"label": "Therapy Changed", "value": analytics.therapy_changed_count or 0},
        {"label": "Therapy Stopped", "value": analytics.therapy_stopped_count or 0},
        {"label": "Total Action Rate", "value": (analytics.action_rate|round(1)|string ~ "%") if analytics.action_rate is not none else "--", "value_class": "text-success"}
    ]) }}
{% endcall %}

<!-- Export -->
<div class="section">
    <h2>Export Data</h2>
    <a href="{{ url_for('dosing_verification.export_active_csv') }}" class="btn btn-success">Export Active Alerts</a>
    <a href="{{ url_for('dosing_verification.export_history_csv') }}?days_back={{ days }}" class="btn btn-success">Export History</a>
</div>

<style>
.chart-wrapper {
    padding: 1rem 0;
}

.resolution-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.resolution-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 4px;
}

.resolution-count {
    font-size: 2rem;
    font-weight: bold;
    color: #0d6efd;
}

.resolution-label {
    font-size: 0.9rem;
    color: #6c757d;
    margin: 0.5rem 0;
}

.resolution-percent {
    font-size: 0.85rem;
    color: #adb5bd;
}
</style>
{% endblock %}
