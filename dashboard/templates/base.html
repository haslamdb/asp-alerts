<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ app_name }}{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=10">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><path d=%22M50 5 L90 20 L90 45 C90 70 70 90 50 95 C30 90 10 70 10 45 L10 20 Z%22 fill=%22%230E7490%22/><path d=%22M50 15 L80 27 L80 45 C80 65 65 80 50 85 C35 80 20 65 20 45 L20 27 Z%22 fill=%22%230891B2%22/><path d=%22M45 55 L35 45 L40 40 L45 45 L60 30 L65 35 Z%22 fill=%22white%22/></svg>">
</head>
<body>
    <nav class="navbar">
        {% set is_hai = request.endpoint and request.endpoint.startswith('hai_detection.') %}
        {% set is_nhsn_reporting = request.endpoint and request.endpoint.startswith('nhsn_reporting.') %}
        {% set is_dashboards = request.endpoint and request.endpoint.startswith('dashboards.') %}
        {% set is_asp_alerts = request.endpoint and request.endpoint.startswith('asp_alerts.') %}
        {% set is_abx_indications = request.endpoint and request.endpoint.startswith('abx_indications.') %}
        {% set is_guideline_adherence = request.endpoint and request.endpoint.startswith('guideline_adherence.') %}
        {% set is_surgical_prophylaxis = request.endpoint and request.endpoint.startswith('surgical_prophylaxis.') %}
        {% set is_drug_bug = request.endpoint and request.endpoint.startswith('drug_bug.') %}
        {% set is_asp_metrics = request.endpoint and request.endpoint.startswith('asp_metrics.') %}
        {% set is_abx_approvals = request.endpoint and request.endpoint.startswith('abx_approvals.') %}
        {% set is_mdro_surveillance = request.endpoint and request.endpoint.startswith('mdro_surveillance.') %}
        {% set is_outbreak_detection = request.endpoint and request.endpoint.startswith('outbreak_detection.') %}
        {% set is_landing = request.endpoint == 'main.landing' %}
        <div class="nav-brand">
            <svg class="nav-shield" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path d="M50 5 L90 20 L90 45 C90 70 70 90 50 95 C30 90 10 70 10 45 L10 20 Z" fill="#0E7490"/>
                <path d="M50 15 L80 27 L80 45 C80 65 65 80 50 85 C35 80 20 65 20 45 L20 27 Z" fill="#0891B2"/>
            </svg>
            {% if is_hai %}
            <a href="{{ url_for('hai_detection.dashboard') }}">HAI Detection</a>
            {% elif is_nhsn_reporting %}
            <a href="{{ url_for('nhsn_reporting.dashboard') }}">NHSN Reporting</a>
            {% elif is_dashboards %}
            <a href="{{ url_for('dashboards.index') }}">Dashboards</a>
            {% elif is_asp_alerts %}
            <a href="{{ url_for('asp_alerts.alerts_active') }}">ASP Alerts</a>
            {% elif is_abx_indications %}
            <a href="{{ url_for('abx_indications.dashboard') }}">Antibiotic Indications</a>
            {% elif is_guideline_adherence %}
            <a href="{{ url_for('guideline_adherence.dashboard') }}">Guideline Adherence</a>
            {% elif is_surgical_prophylaxis %}
            <a href="{{ url_for('surgical_prophylaxis.dashboard') }}">Surgical Prophylaxis</a>
            {% elif is_drug_bug %}
            <a href="{{ url_for('drug_bug.dashboard') }}">Drug-Bug Mismatch</a>
            {% elif is_asp_metrics %}
            <a href="{{ url_for('asp_metrics.dashboard') }}">ASP/IP Metrics</a>
            {% elif is_abx_approvals %}
            <a href="{{ url_for('abx_approvals.dashboard') }}">ABX Approvals</a>
            {% elif is_mdro_surveillance %}
            <a href="{{ url_for('mdro_surveillance.dashboard') }}">MDRO Surveillance</a>
            {% elif is_outbreak_detection %}
            <a href="{{ url_for('outbreak_detection.dashboard') }}">Outbreak Detection</a>
            {% else %}
            <a href="{{ url_for('main.landing') }}">AEGIS</a>
            {% endif %}
        </div>
        <div class="nav-links">
            {% if is_landing or request.endpoint == 'main.about' %}
            <a href="{{ url_for('main.about') }}">About</a>
            {% elif is_hai %}
            <!-- HAI Detection Navigation -->
            <a href="{{ url_for('hai_detection.dashboard') }}" {% if request.endpoint in ['hai_detection.dashboard', 'hai_detection.candidate_detail'] %}class="active"{% endif %}>Dashboard</a>
            <a href="{{ url_for('hai_detection.history') }}" {% if request.endpoint == 'hai_detection.history' %}class="active"{% endif %}>History</a>
            <a href="{{ url_for('hai_detection.reports') }}" {% if request.endpoint == 'hai_detection.reports' %}class="active"{% endif %}>Reports</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            <a href="{{ url_for('hai_detection.help_page') }}" {% if request.endpoint == 'hai_detection.help_page' %}class="active"{% endif %}>Help</a>
            {% elif is_nhsn_reporting %}
            <!-- NHSN Reporting Navigation -->
            <a href="{{ url_for('nhsn_reporting.dashboard') }}" {% if request.endpoint == 'nhsn_reporting.dashboard' %}class="active"{% endif %}>Dashboard</a>
            <a href="{{ url_for('nhsn_reporting.au_detail') }}" {% if request.endpoint == 'nhsn_reporting.au_detail' %}class="active"{% endif %}>AU Detail</a>
            <a href="{{ url_for('nhsn_reporting.ar_detail') }}" {% if request.endpoint == 'nhsn_reporting.ar_detail' %}class="active"{% endif %}>AR Detail</a>
            <a href="{{ url_for('nhsn_reporting.hai_detail') }}" {% if request.endpoint == 'nhsn_reporting.hai_detail' %}class="active"{% endif %}>HAI Detail</a>
            <a href="{{ url_for('nhsn_reporting.denominators') }}" {% if request.endpoint == 'nhsn_reporting.denominators' %}class="active"{% endif %}>Denominators</a>
            <a href="{{ url_for('nhsn_reporting.submission') }}" {% if request.endpoint == 'nhsn_reporting.submission' %}class="active"{% endif %}>Submission</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            <a href="{{ url_for('nhsn_reporting.help_page') }}" {% if request.endpoint == 'nhsn_reporting.help_page' %}class="active"{% endif %}>Help</a>
            {% elif is_dashboards %}
            <!-- Dashboards Navigation -->
            <a href="{{ url_for('dashboards.index') }}" {% if request.endpoint == 'dashboards.index' %}class="active"{% endif %}>Overview</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            {% elif is_asp_alerts %}
            <!-- ASP Alerts Navigation -->
            <a href="{{ url_for('asp_alerts.alerts_active') }}" {% if request.endpoint == 'asp_alerts.alerts_active' %}class="active"{% endif %}>Active Alerts</a>
            <a href="{{ url_for('asp_alerts.alerts_history') }}" {% if request.endpoint == 'asp_alerts.alerts_history' %}class="active"{% endif %}>History</a>
            <a href="{{ url_for('asp_alerts.reports') }}" {% if request.endpoint == 'asp_alerts.reports' %}class="active"{% endif %}>Reports</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            <a href="{{ url_for('asp_alerts.help_page') }}" {% if request.endpoint == 'asp_alerts.help_page' %}class="active"{% endif %}>Help</a>
            {% elif is_abx_indications %}
            <!-- Antibiotic Indications Navigation -->
            <a href="{{ url_for('abx_indications.dashboard') }}" {% if request.endpoint in ['abx_indications.dashboard', 'abx_indications.candidate_detail'] %}class="active"{% endif %}>Dashboard</a>
            <a href="{{ url_for('abx_indications.pending_list') }}" {% if request.endpoint == 'abx_indications.pending_list' %}class="active"{% endif %}>Pending</a>
            <a href="{{ url_for('abx_indications.reviewed_list') }}" {% if request.endpoint == 'abx_indications.reviewed_list' %}class="active"{% endif %}>Reviewed</a>
            <a href="{{ url_for('abx_indications.analytics') }}" {% if request.endpoint == 'abx_indications.analytics' %}class="active"{% endif %}>Analytics</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            <a href="{{ url_for('abx_indications.help_page') }}" {% if request.endpoint == 'abx_indications.help_page' %}class="active"{% endif %}>Help</a>
            {% elif is_guideline_adherence %}
            <!-- Guideline Adherence Navigation -->
            <a href="{{ url_for('guideline_adherence.dashboard') }}" {% if request.endpoint == 'guideline_adherence.dashboard' %}class="active"{% endif %}>Dashboard</a>
            <a href="{{ url_for('guideline_adherence.active_episodes') }}" {% if request.endpoint in ['guideline_adherence.active_episodes', 'guideline_adherence.episode_detail', 'guideline_adherence.episode_detail_full'] %}class="active"{% endif %}>Active</a>
            <a href="{{ url_for('guideline_adherence.episode_history') }}" {% if request.endpoint == 'guideline_adherence.episode_history' %}class="active"{% endif %}>History</a>
            <a href="{{ url_for('guideline_adherence.compliance_metrics') }}" {% if request.endpoint == 'guideline_adherence.compliance_metrics' %}class="active"{% endif %}>Metrics</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            <a href="{{ url_for('guideline_adherence.help_page') }}" {% if request.endpoint == 'guideline_adherence.help_page' %}class="active"{% endif %}>Help</a>
            {% elif is_surgical_prophylaxis %}
            <!-- Surgical Prophylaxis Navigation -->
            <a href="{{ url_for('surgical_prophylaxis.dashboard') }}" {% if request.endpoint == 'surgical_prophylaxis.dashboard' %}class="active"{% endif %}>Dashboard</a>
            <a href="{{ url_for('surgical_prophylaxis.case_list') }}" {% if request.endpoint in ['surgical_prophylaxis.case_list', 'surgical_prophylaxis.case_detail'] %}class="active"{% endif %}>Cases</a>
            <a href="{{ url_for('surgical_prophylaxis.alert_list') }}" {% if request.endpoint == 'surgical_prophylaxis.alert_list' %}class="active"{% endif %}>Alerts</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            <a href="{{ url_for('surgical_prophylaxis.help_page') }}" {% if request.endpoint == 'surgical_prophylaxis.help_page' %}class="active"{% endif %}>Help</a>
            {% elif is_drug_bug %}
            <!-- Drug-Bug Mismatch Navigation -->
            <a href="{{ url_for('drug_bug.dashboard') }}" {% if request.endpoint == 'drug_bug.dashboard' %}class="active"{% endif %}>Dashboard</a>
            <a href="{{ url_for('drug_bug.history') }}" {% if request.endpoint == 'drug_bug.history' %}class="active"{% endif %}>History</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            <a href="{{ url_for('drug_bug.help_page') }}" {% if request.endpoint == 'drug_bug.help_page' %}class="active"{% endif %}>Help</a>
            {% elif is_asp_metrics %}
            <!-- ASP/IP Metrics Navigation -->
            <a href="{{ url_for('asp_metrics.dashboard') }}" {% if request.endpoint == 'asp_metrics.dashboard' %}class="active"{% endif %}>Dashboard</a>
            <a href="{{ url_for('asp_metrics.workload') }}" {% if request.endpoint == 'asp_metrics.workload' %}class="active"{% endif %}>Workload</a>
            <a href="{{ url_for('asp_metrics.targets') }}" {% if request.endpoint and 'target' in request.endpoint %}class="active"{% endif %}>Targets</a>
            <a href="{{ url_for('asp_metrics.trends') }}" {% if request.endpoint == 'asp_metrics.trends' %}class="active"{% endif %}>Trends</a>
            <a href="{{ url_for('asp_metrics.interventions') }}" {% if request.endpoint and 'intervention' in request.endpoint %}class="active"{% endif %}>Interventions</a>
            <a href="{{ url_for('asp_metrics.llm_performance') }}" {% if request.endpoint == 'asp_metrics.llm_performance' %}class="active"{% endif %}>LLM Performance</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            {% elif is_abx_approvals %}
            <!-- ABX Approvals Navigation -->
            <a href="{{ url_for('abx_approvals.dashboard') }}" {% if request.endpoint == 'abx_approvals.dashboard' %}class="active"{% endif %}>Dashboard</a>
            <a href="{{ url_for('abx_approvals.new_request') }}" {% if request.endpoint in ['abx_approvals.new_request', 'abx_approvals.search_patients', 'abx_approvals.patient_detail'] %}class="active"{% endif %}>New Request</a>
            <a href="{{ url_for('abx_approvals.history') }}" {% if request.endpoint == 'abx_approvals.history' %}class="active"{% endif %}>History</a>
            <a href="{{ url_for('abx_approvals.reports') }}" {% if request.endpoint == 'abx_approvals.reports' %}class="active"{% endif %}>Reports</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            <a href="{{ url_for('abx_approvals.help_page') }}" {% if request.endpoint == 'abx_approvals.help_page' %}class="active"{% endif %}>Help</a>
            {% elif is_mdro_surveillance %}
            <!-- MDRO Surveillance Navigation -->
            <a href="{{ url_for('mdro_surveillance.dashboard') }}" {% if request.endpoint == 'mdro_surveillance.dashboard' %}class="active"{% endif %}>Dashboard</a>
            <a href="{{ url_for('mdro_surveillance.cases_list') }}" {% if request.endpoint in ['mdro_surveillance.cases_list', 'mdro_surveillance.case_detail'] %}class="active"{% endif %}>Cases</a>
            <a href="{{ url_for('mdro_surveillance.analytics') }}" {% if request.endpoint == 'mdro_surveillance.analytics' %}class="active"{% endif %}>Analytics</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            <a href="{{ url_for('mdro_surveillance.help_page') }}" {% if request.endpoint == 'mdro_surveillance.help_page' %}class="active"{% endif %}>Help</a>
            {% elif is_outbreak_detection %}
            <!-- Outbreak Detection Navigation -->
            <a href="{{ url_for('outbreak_detection.dashboard') }}" {% if request.endpoint == 'outbreak_detection.dashboard' %}class="active"{% endif %}>Dashboard</a>
            <a href="{{ url_for('outbreak_detection.clusters_list') }}" {% if request.endpoint in ['outbreak_detection.clusters_list', 'outbreak_detection.cluster_detail'] %}class="active"{% endif %}>Clusters</a>
            <a href="{{ url_for('outbreak_detection.alerts_list') }}" {% if request.endpoint == 'outbreak_detection.alerts_list' %}class="active"{% endif %}>Alerts</a>
            <a href="{{ url_for('main.landing') }}" class="nav-home">Main</a>
            <a href="{{ url_for('outbreak_detection.help_page') }}" {% if request.endpoint == 'outbreak_detection.help_page' %}class="active"{% endif %}>Help</a>
            {% endif %}
        </div>
    </nav>

    <main class="container">
        {% if request.args.get('msg') %}
        <div class="flash-message flash-{{ 'success' if 'failed' not in request.args.get('msg') else 'error' }}">
            {% if request.args.get('msg') == 'acknowledged' %}
                Alert acknowledged successfully.
            {% elif request.args.get('msg') == 'snoozed' %}
                Alert snoozed successfully.
            {% elif request.args.get('msg') == 'resolved' %}
                Alert resolved successfully.
            {% elif request.args.get('msg') == 'ack_failed' %}
                Failed to acknowledge alert.
            {% elif request.args.get('msg') == 'snooze_failed' %}
                Failed to snooze alert.
            {% elif request.args.get('msg') == 'note_added' %}
                Note added successfully.
            {% elif request.args.get('msg') == 'note_empty' %}
                Note cannot be empty.
            {% elif request.args.get('msg') == 'note_failed' %}
                Failed to add note.
            {% else %}
                {{ request.args.get('msg') }}
            {% endif %}
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <div class="disclaimer-banner">
        <strong>Demo Environment:</strong> All patient data displayed is simulated. No actual patient data is available through this dashboard.
    </div>

    <footer class="footer">
        <p>AEGIS Dashboard &bull; Cincinnati Children's Hospital</p>
    </footer>

    <script>
    // Relative time formatting
    function timeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        const intervals = {
            year: 31536000,
            month: 2592000,
            week: 604800,
            day: 86400,
            hour: 3600,
            minute: 60
        };

        for (const [unit, secondsInUnit] of Object.entries(intervals)) {
            const interval = Math.floor(seconds / secondsInUnit);
            if (interval >= 1) {
                return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
            }
        }
        return 'just now';
    }

    // Update all relative times on the page
    function updateRelativeTimes() {
        document.querySelectorAll('[data-timestamp]').forEach(el => {
            const timestamp = el.getAttribute('data-timestamp');
            el.textContent = timeAgo(timestamp);

            // Mark as urgent if more than 4 hours old and not resolved
            const hours = (new Date() - new Date(timestamp)) / (1000 * 60 * 60);
            if (hours > 4 && !el.closest('.resolved')) {
                el.setAttribute('data-urgent', 'true');
            }
        });
    }

    // Auto-refresh for active alerts page
    let refreshInterval;
    const REFRESH_SECONDS = 30;

    function startAutoRefresh() {
        const indicator = document.getElementById('refresh-indicator');
        const countdown = document.getElementById('refresh-countdown');

        if (!indicator) return;

        let seconds = REFRESH_SECONDS;

        refreshInterval = setInterval(() => {
            seconds--;
            if (countdown) countdown.textContent = seconds;

            if (seconds <= 0) {
                location.reload();
            }
        }, 1000);
    }

    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        updateRelativeTimes();
        setInterval(updateRelativeTimes, 60000); // Update every minute

        if (document.getElementById('refresh-indicator')) {
            startAutoRefresh();
        }
    });

    // Pause refresh when tab is not visible
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopAutoRefresh();
        } else if (document.getElementById('refresh-indicator')) {
            startAutoRefresh();
        }
    });
    </script>
</body>
</html>
