{% extends "base.html" %}

{% block title %}By Unit - Action Analytics - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Unit-Level Analysis</h1>
    <p class="page-description">Action volume and intervention breakdown by hospital unit and service.</p>
</div>

{% if error is defined and error %}
<div class="alert alert-error">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

{# Filter bar #}
<form method="get" class="aa-filter-bar">
    <div class="aa-filter-group">
        <label for="filter-days">Period:</label>
        <select id="filter-days" name="days" onchange="this.form.submit()">
            {% for d in [7, 14, 30, 60, 90] %}
            <option value="{{ d }}" {% if days == d %}selected{% endif %}>Last {{ d }} days</option>
            {% endfor %}
        </select>
    </div>
    <div class="aa-filter-group">
        <a href="{{ url_for('action_analytics.dashboard') }}" class="btn btn-secondary btn-sm">Back to Dashboard</a>
        <a href="{{ url_for('action_analytics.export_unit_csv', days=days) }}" class="btn btn-secondary btn-sm">Export CSV</a>
    </div>
</form>

{# Unit Metrics Table #}
<div class="dashboard-card">
    <h3>By Unit/Location</h3>
    {% if unit_metrics %}
    <table class="data-table aa-sortable">
        <thead>
            <tr>
                <th>Unit</th>
                <th>Total Actions</th>
                <th>Reviews</th>
                <th>Interventions</th>
                <th>Unique Providers</th>
                <th>Avg Duration (min)</th>
                <th>Volume</th>
            </tr>
        </thead>
        <tbody>
            {% set max_actions = unit_metrics[0].action_count if unit_metrics else 1 %}
            {% for unit in unit_metrics %}
            <tr>
                <td><strong>{{ unit.unit }}</strong></td>
                <td>{{ unit.action_count }}</td>
                <td>{{ unit.review_count }}</td>
                <td>{{ unit.intervention_count }}</td>
                <td>{{ unit.unique_providers }}</td>
                <td>{{ unit.avg_duration }}</td>
                <td>
                    <div class="breakdown-bar-container">
                        <div class="breakdown-bar breakdown-bar--unit" style="width: {{ (unit.action_count / max_actions * 100) | round }}%"></div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">No unit-level data available</p>
    {% endif %}
</div>

{# Service Metrics Table #}
<div class="dashboard-card">
    <h3>By Medical Service</h3>
    {% if service_metrics %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Service</th>
                <th>Total Actions</th>
                <th>Reviews</th>
                <th>Interventions</th>
                <th>Unique Providers</th>
                <th>Volume</th>
            </tr>
        </thead>
        <tbody>
            {% set max_svc = service_metrics[0].action_count if service_metrics else 1 %}
            {% for svc in service_metrics %}
            <tr>
                <td><strong>{{ svc.service }}</strong></td>
                <td>{{ svc.action_count }}</td>
                <td>{{ svc.review_count }}</td>
                <td>{{ svc.intervention_count }}</td>
                <td>{{ svc.unique_providers }}</td>
                <td>
                    <div class="breakdown-bar-container">
                        <div class="breakdown-bar breakdown-bar--service" style="width: {{ (svc.action_count / max_svc * 100) | round }}%"></div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">No service-level data available</p>
    {% endif %}
</div>

<style>
.aa-filter-bar { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
.aa-filter-group { display: flex; align-items: center; gap: 0.5rem; }
.aa-filter-group label { font-size: 0.875rem; font-weight: 500; color: #374151; }
.aa-filter-group select { padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; background: white; }
.btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
.page-description { color: #6b7280; font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 1rem; }
.breakdown-bar-container { height: 20px; background: #f3f4f6; border-radius: 4px; overflow: hidden; min-width: 150px; }
.breakdown-bar { height: 100%; border-radius: 4px; }
.breakdown-bar--unit { background: linear-gradient(90deg, #0891B2 0%, #06b6d4 100%); }
.breakdown-bar--service { background: linear-gradient(90deg, #7c3aed 0%, #a78bfa 100%); }
.empty-state { text-align: center; color: #6b7280; padding: 2rem; }
</style>
{% endblock %}
