{% extends "base.html" %}

{% block title %}Antibiotic Indications - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Antibiotic Indications</h1>
    <a href="{{ url_for('abx_indications.help_page') }}" class="btn btn-secondary">Help</a>
</div>

<div class="dashboard-summary">
    <div class="summary-card">
        <div class="summary-icon" style="color: var(--color-success);">&#x2705;</div>
        <div class="summary-content">
            <div class="summary-value">{{ counts.get('A', 0) + counts.get('FN', 0) }}</div>
            <div class="summary-label">Always Indicated</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon" style="color: var(--color-warning);">&#x26A0;</div>
        <div class="summary-content">
            <div class="summary-value">{{ counts.get('S', 0) }}</div>
            <div class="summary-label">Sometimes Indicated</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon" style="color: var(--color-danger);">&#x274C;</div>
        <div class="summary-content">
            <div class="summary-value">{{ counts.get('N', 0) }}</div>
            <div class="summary-label">Never Indicated</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon" style="color: var(--color-primary);">&#x1F3E5;</div>
        <div class="summary-content">
            <div class="summary-value">{{ counts.get('P', 0) }}</div>
            <div class="summary-label">Prophylaxis</div>
        </div>
    </div>
</div>

{% if recent_candidates %}
<div class="recent-candidates">
    <h2>Recent Assessments <span class="subtitle">(Last 7 days)</span></h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Patient MRN</th>
                <th>Antibiotic</th>
                <th>Order Date</th>
                <th>Indication</th>
                <th>ICD-10 Class</th>
                <th>Final</th>
                <th>Source</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for c in recent_candidates %}
            <tr>
                <td>{{ c.patient.mrn or '-' }}</td>
                <td>{{ c.medication.medication_name or '-' }}</td>
                <td>{{ c.medication.start_date.strftime('%Y-%m-%d') if c.medication.start_date else '-' }}</td>
                <td class="indication-cell">
                    {% if c.icd10_primary_indication %}
                        {{ c.icd10_primary_indication }}
                    {% elif c.llm_extracted_indication %}
                        <em>{{ c.llm_extracted_indication }}</em>
                    {% else %}
                        <span class="text-muted">No indication</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge badge-classification-{{ c.icd10_classification or 'U' }}">
                        {{ c.icd10_classification or 'U' }}
                    </span>
                </td>
                <td>
                    <span class="badge badge-classification-{{ c.final_classification or 'U' }}">
                        {{ c.final_classification or 'U' }}
                    </span>
                </td>
                <td>{{ c.classification_source or '-' }}</td>
                <td>
                    {% if c.alert_id %}
                    <a href="{{ url_for('asp_alerts.alert_detail', alert_id=c.alert_id) }}" class="badge-link">
                        <span class="badge badge-status-{{ c.status or 'pending' }}">
                            {{ c.status or 'pending' }}
                        </span>
                    </a>
                    {% else %}
                    <span class="badge badge-status-{{ c.status or 'pending' }}">
                        {{ c.status or 'pending' }}
                    </span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="module-info">
    <h2>About This Module</h2>
    <p>The Antibiotic Indications module provides automated classification of antibiotic indication appropriateness
       using ICD-10 based assessment following the Chua et al. methodology with pediatric inpatient modifications.</p>

    <h3>Classification Categories</h3>
    <table class="help-table">
        <thead>
            <tr>
                <th>Category</th>
                <th>Code</th>
                <th>Meaning</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><span class="badge badge-success">Always</span></td>
                <td>A</td>
                <td>Antibiotic indicated - documented bacterial infection</td>
            </tr>
            <tr>
                <td><span class="badge badge-warning">Sometimes</span></td>
                <td>S</td>
                <td>May need antibiotics - clinical judgment required</td>
            </tr>
            <tr>
                <td><span class="badge badge-critical">Never</span></td>
                <td>N</td>
                <td>No antibiotic indication - likely inappropriate</td>
            </tr>
            <tr>
                <td><span class="badge badge-info">Prophylaxis</span></td>
                <td>P</td>
                <td>Surgical or medical prophylaxis indication</td>
            </tr>
            <tr>
                <td><span class="badge badge-success">Febrile Neutropenia</span></td>
                <td>FN</td>
                <td>Neutropenia + fever - empiric therapy indicated</td>
            </tr>
        </tbody>
    </table>

    <h3>Three-Layer Appropriateness Model</h3>
    <div class="layer-cards">
        <div class="layer-card layer-complete">
            <h4>Layer 1: Indication</h4>
            <p>Is there ANY indication for antibiotics?</p>
            <span class="layer-status">Implemented</span>
        </div>
        <div class="layer-card layer-planned">
            <h4>Layer 2: Agent</h4>
            <p>Is THIS antibiotic appropriate for the indication?</p>
            <span class="layer-status">Phase 2</span>
        </div>
        <div class="layer-card layer-planned">
            <h4>Layer 3: Duration</h4>
            <p>Is the DURATION appropriate?</p>
            <span class="layer-status">Phase 3</span>
        </div>
    </div>

    <h3>Special Logic</h3>
    <ul>
        <li><strong>Febrile Neutropenia:</strong> Automatically detected when neutropenia code (D70.x) + fever</li>
        <li><strong>Surgical Prophylaxis:</strong> Validated against 55+ CPT codes with agent/duration recommendations</li>
        <li><strong>Pediatric Modifications:</strong> Inpatient-specific overrides (e.g., bacteremia R78.81: N â†’ A)</li>
    </ul>
</div>

{% if override_stats and override_stats.get('total_reviews', 0) > 0 %}
<div class="override-stats">
    <h3>Review Statistics (Last 30 Days)</h3>
    <p>
        <strong>{{ override_stats.get('total_reviews', 0) }}</strong> reviews completed,
        <strong>{{ override_stats.get('total_overrides', 0) }}</strong> overrides
        ({{ "%.1f"|format(override_stats.get('override_rate', 0) * 100) }}% override rate)
    </p>
</div>
{% endif %}

<style>
.dashboard-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.recent-candidates {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    margin-bottom: 2rem;
}

.recent-candidates h2 {
    margin: 0 0 1rem 0;
    color: var(--color-gray-800);
}

.recent-candidates .subtitle {
    font-size: 0.875rem;
    font-weight: 400;
    color: var(--color-gray-500);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-gray-200);
}

.data-table th {
    background: var(--color-gray-50);
    font-weight: 600;
    color: var(--color-gray-700);
    font-size: 0.875rem;
}

.data-table td {
    font-size: 0.875rem;
    color: var(--color-gray-700);
}

.data-table tbody tr:hover {
    background: var(--color-gray-50);
}

/* Classification badges */
.badge-classification-A {
    background: var(--color-success);
    color: white;
}

.badge-classification-FN {
    background: var(--color-success);
    color: white;
}

.badge-classification-S {
    background: var(--color-warning);
    color: var(--color-gray-900);
}

.badge-classification-N {
    background: var(--color-danger);
    color: white;
}

.badge-classification-P {
    background: var(--color-primary);
    color: white;
}

.badge-classification-U {
    background: var(--color-gray-400);
    color: white;
}

/* Status badges */
.badge-status-pending {
    background: var(--color-warning);
    color: var(--color-gray-900);
}

.badge-status-alerted {
    background: var(--color-danger);
    color: white;
}

.badge-status-reviewed {
    background: var(--color-success);
    color: white;
}

.override-stats {
    background: var(--color-info-light);
    border: 1px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
}

.override-stats h3 {
    margin: 0 0 0.5rem 0;
    color: var(--color-primary);
    font-size: 1rem;
}

.override-stats p {
    margin: 0;
    color: var(--color-gray-700);
}

.indication-cell {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.indication-cell em {
    color: var(--color-gray-600);
}

.text-muted {
    color: var(--color-gray-400);
    font-style: italic;
}

.badge-link {
    text-decoration: none;
}

.badge-link:hover .badge {
    opacity: 0.85;
    transform: scale(1.05);
}

.badge-link .badge {
    cursor: pointer;
    transition: opacity 0.15s, transform 0.15s;
}

.summary-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.summary-icon {
    font-size: 2rem;
}

.summary-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-gray-800);
}

.summary-label {
    font-size: 0.875rem;
    color: var(--color-gray-600);
}

.module-info {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-md);
    margin-bottom: 2rem;
}

.module-info h2 {
    margin-bottom: 1rem;
    color: var(--color-gray-800);
}

.module-info h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--color-gray-700);
}

.layer-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.layer-card {
    padding: 1rem;
    border-radius: var(--radius-md);
    border-left: 4px solid;
}

.layer-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
}

.layer-card p {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    color: var(--color-gray-600);
}

.layer-status {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
}

.layer-complete {
    background: var(--color-success-light);
    border-color: var(--color-success);
}

.layer-complete .layer-status {
    background: var(--color-success);
    color: white;
}

.layer-planned {
    background: var(--color-gray-100);
    border-color: var(--color-gray-400);
}

.layer-planned .layer-status {
    background: var(--color-gray-400);
    color: white;
}

.coming-soon-notice {
    background: var(--color-info-light);
    border: 1px dashed var(--color-primary);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    text-align: center;
}

.coming-soon-notice h3 {
    margin: 0 0 0.5rem 0;
    color: var(--color-primary);
}

.coming-soon-notice p {
    margin: 0;
    color: var(--color-gray-600);
}
</style>
{% endblock %}
