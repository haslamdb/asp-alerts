{% extends "base.html" %}

{% block title %}Guideline Adherence - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Guideline Adherence</h1>
    <div class="header-actions">
        <a href="{{ url_for('guideline_adherence.active_episodes') }}" class="btn btn-primary">Active Episodes</a>
        <a href="{{ url_for('guideline_adherence.episode_history') }}" class="btn btn-secondary">History</a>
        <a href="{{ url_for('guideline_adherence.compliance_metrics') }}" class="btn btn-secondary">Metrics</a>
        <a href="{{ url_for('guideline_adherence.help_page') }}" class="btn btn-secondary">Help</a>
    </div>
</div>

<!-- Stats Cards -->
<div class="dashboard-summary">
    <div class="summary-card">
        <div class="summary-icon icon-success">&#x1F4C8;</div>
        <div class="summary-content">
            {% if metrics and metrics.element_rates %}
                {% set total_rate = namespace(sum=0, count=0) %}
                {% for er in metrics.element_rates %}
                    {% set total_rate.sum = total_rate.sum + er.compliance_rate %}
                    {% set total_rate.count = total_rate.count + 1 %}
                {% endfor %}
                <div class="summary-value">{{ (total_rate.sum / total_rate.count)|round(1) if total_rate.count > 0 else '--' }}%</div>
            {% else %}
                <div class="summary-value">--</div>
            {% endif %}
            <div class="summary-label">Overall Compliance</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon icon-primary">&#x1F4CB;</div>
        <div class="summary-content">
            <div class="summary-value">{{ bundles|length }}</div>
            <div class="summary-label">Guidelines Tracked</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon icon-warning">&#x1F50D;</div>
        <div class="summary-content">
            <div class="summary-value">{{ metrics.episode_counts.total if metrics and metrics.episode_counts else '--' }}</div>
            <div class="summary-label">Episodes (30 days)</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon icon-danger">&#x26A0;</div>
        <div class="summary-content">
            <div class="summary-value">{{ active_episodes|length }}</div>
            <div class="summary-label">Active Monitoring</div>
        </div>
    </div>
</div>

<!-- Active Episodes -->
{% if active_episodes %}
<div class="section section-card">
    <h2>Recent Active Episodes</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Patient</th>
                <th>Bundle</th>
                <th>Trigger Time</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for ep in active_episodes %}
            <tr>
                <td>
                    <span class="patient-name">{{ ep.patient_name or 'Unknown' }}</span>
                    {% if ep.patient_mrn %}<br><span class="patient-mrn">MRN: {{ ep.patient_mrn }}</span>{% endif %}
                </td>
                <td>{{ ep.bundle_name or ep.bundle_id }}</td>
                <td>{{ ep.trigger_time[:16] if ep.trigger_time else '-' }}</td>
                <td><span class="badge badge-status-{{ ep.status }}">{{ ep.status }}</span></td>
                <td>
                    <a href="{{ url_for('guideline_adherence.episode_detail', episode_id=ep.id) }}" class="btn btn-small">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="section-footer">
        <a href="{{ url_for('guideline_adherence.active_episodes') }}" class="btn btn-secondary">View All Active Episodes</a>
    </div>
</div>
{% else %}
<div class="section section-card">
    <h2>Active Episodes</h2>
    <div class="empty-state">
        <p>No active episodes currently being monitored.</p>
        <p class="text-muted">
            Episodes appear here when patients are identified with conditions matching monitored bundles.
        </p>
    </div>
</div>
{% endif %}

<!-- Bundle Stats -->
{% if bundle_stats %}
<div class="section section-card">
    <h2>Bundle Compliance</h2>
    <div class="guideline-cards">
        {% for bs in bundle_stats %}
        <a href="{{ url_for('guideline_adherence.bundle_detail', bundle_id=bs.bundle_id) }}" class="guideline-card">
            <h4>{{ bs.bundle_name }}</h4>
            <div class="bundle-stat">
                <span class="compliance-badge {% if bs.avg_compliance >= 90 %}success{% elif bs.avg_compliance >= 70 %}warning{% else %}danger{% endif %}">
                    {{ bs.avg_compliance }}%
                </span>
            </div>
            <p>{{ bs.total_episodes }} episodes, {{ bs.active_episodes }} active</p>
            <span class="element-count">{{ bs.element_count }} elements</span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}
