{% extends "base.html" %}
{% from "macros/components.html" import detail_list %}

{% block title %}Alert {{ alert.id[:8] }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Alert Details</h1>
    <a href="{{ url_for('asp_alerts.alerts_active') }}" class="btn btn-secondary">Back to Active</a>
</div>

<div class="alert-detail-layout alert-detail-page">
    <!-- Left Column: Alert Information -->
    <div class="alert-detail-main">
        <div class="alert-detail-card">
            <div class="alert-header">
                <div class="alert-id">
                    <span class="badge badge-{{ alert.severity }}">{{ alert.severity.upper() }}</span>
                    <span class="badge badge-status-{{ alert.status.value }}">{{ alert.status.value.upper() }}</span>
                    <span class="alert-type">{{ alert.alert_type.value }}</span>
                </div>
                <div class="alert-title">{{ alert.title or 'Untitled Alert' }}</div>
            </div>

            <div class="alert-body">
                <!-- Patient & Timeline side-by-side -->
                <div class="info-row-compact">
                    <div class="info-section">
                        <h3>Patient</h3>
                        {{ detail_list([
                            {'label': 'Name', 'value': alert.patient_name or 'Unknown', 'bold': true},
                            {'label': 'MRN', 'value': alert.patient_mrn or 'Unknown'}
                        ], compact=true) }}
                    </div>

                    <div class="info-section">
                        <h3>Timeline</h3>
                        {% set timeline_items = [
                            {'label': 'Created', 'value': alert.created_at.strftime('%m/%d %H:%M') if alert.created_at else '-'}
                        ] %}
                        {% if alert.acknowledged_at %}
                            {% set _ = timeline_items.append({'label': "Ack'd", 'value': alert.acknowledged_at.strftime('%m/%d %H:%M')}) %}
                        {% endif %}
                        {% if alert.resolved_at %}
                            {% set _ = timeline_items.append({'label': 'Resolved', 'value': alert.resolved_at.strftime('%m/%d %H:%M')}) %}
                        {% endif %}
                        {{ detail_list(timeline_items, compact=true) }}
                    </div>
                </div>

                {% if alert.summary %}
                <div class="info-section">
                    <h3>Summary</h3>
                    <p>{{ alert.summary }}</p>
                </div>
                {% endif %}

                {% if alert.content %}
                <div class="info-section">
                    <h3>Clinical Details</h3>

                    {% if alert.alert_type.value == 'drug_bug_mismatch' %}
                    {# Drug-Bug Mismatch specific display #}
                    <dl>
                        <dt>Organism</dt>
                        <dd><strong>{{ alert.content.get('organism', 'Unknown') }}</strong></dd>

                        <dt>Culture Source</dt>
                        <dd>{{ alert.content.get('specimen_type') or 'Not specified' }}</dd>

                        {% if alert.content.get('collection_date') %}
                        <dt>Collection Date</dt>
                        <dd>{{ alert.content.get('collection_date')[:10] if alert.content.get('collection_date') else '-' }}</dd>
                        {% endif %}

                        <dt>Mismatch Type</dt>
                        <dd>
                            {% set mismatch_type = alert.content.get('mismatch_type', 'unknown') %}
                            <span class="badge badge-{% if mismatch_type == 'resistant' %}danger{% elif mismatch_type == 'intermediate' %}warning{% elif mismatch_type == 'no_coverage' %}info{% else %}secondary{% endif %}">
                                {{ mismatch_type|replace('_', ' ')|title }}
                            </span>
                        </dd>

                        <dt>Current Antibiotic(s)</dt>
                        <dd>
                            {% if alert.content.get('current_antibiotics') %}
                            {% for abx in alert.content.get('current_antibiotics', []) %}
                            <strong>{{ abx.get('name', 'Unknown') }}</strong>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% else %}
                            <span class="text-muted">No active antibiotics identified</span>
                            {% endif %}
                        </dd>

                        {% if alert.content.get('susceptible_options') %}
                        <dt>Susceptible Options</dt>
                        <dd>
                            {% for option in alert.content.get('susceptible_options', []) %}
                            <span class="badge badge-success">{{ option|replace(' Susceptibility', '')|replace(' susceptibility', '') }}</span>
                            {% endfor %}
                        </dd>
                        {% endif %}

                        <dt>Recommendation</dt>
                        <dd class="recommendation-text">{{ alert.content.get('recommendation', '-')|replace(' Susceptibility', '')|replace(' susceptibility', '') }}</dd>
                    </dl>

                    {% if alert.content.get('susceptibility_panel') %}
                    <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Susceptibility Panel</h4>
                    <table class="susceptibility-table">
                        <thead>
                            <tr>
                                <th>Antibiotic</th>
                                <th>Result</th>
                                <th>MIC</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in alert.content.get('susceptibility_panel', []) %}
                            <tr class="susc-{{ row.get('result', 'u')|lower }}">
                                <td>{{ row.get('antibiotic', '-')|replace(' Susceptibility', '')|replace(' susceptibility', '') }}</td>
                                <td>
                                    <div class="susc-result">
                                        <span class="susc-badge susc-{{ row.get('result', 'u')|lower }}">{{ row.get('result', '-') }}</span>
                                        <span class="susc-text">
                                            {% if row.get('result') == 'S' %}Susceptible
                                            {% elif row.get('result') == 'I' %}Intermediate
                                            {% elif row.get('result') == 'R' %}Resistant
                                            {% endif %}
                                        </span>
                                    </div>
                                </td>
                                <td>{{ row.get('mic', '-') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}

                    {% elif alert.alert_type.value == 'abx_no_indication' %}
                    {# Indication-specific display #}
                    <dl>
                        <dt>Medication</dt>
                        <dd><strong>{{ alert.content.get('medication_name', 'Unknown') }}</strong></dd>

                        {% if alert.content.get('order_date') %}
                        <dt>Order Date</dt>
                        <dd>{{ alert.content.get('order_date') }}</dd>
                        {% endif %}

                        <dt>ICD-10 Classification</dt>
                        <dd>
                            {% set classification = alert.content.get('icd10_classification', 'U') %}
                            <span class="badge badge-classification-{{ classification }}">
                                {% if classification == 'N' %}Never Appropriate
                                {% elif classification == 'U' %}Unknown
                                {% elif classification == 'S' %}Sometimes
                                {% elif classification == 'A' %}Always
                                {% else %}{{ classification }}
                                {% endif %}
                            </span>
                        </dd>

                        {% if alert.content.get('icd10_primary_indication') %}
                        <dt>Primary ICD-10 Indication</dt>
                        <dd>{{ alert.content.get('icd10_primary_indication') }}</dd>
                        {% endif %}

                        {% if alert.content.get('icd10_codes') %}
                        <dt>ICD-10 Codes</dt>
                        <dd>
                            {% for code in alert.content.get('icd10_codes', [])[:5] %}
                            <code>{{ code }}</code>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% if alert.content.get('icd10_codes')|length > 5 %}
                            <em>... and {{ alert.content.get('icd10_codes')|length - 5 }} more</em>
                            {% endif %}
                        </dd>
                        {% endif %}

                        {% if alert.content.get('llm_attempted') %}
                        <dt>LLM Extraction</dt>
                        <dd>
                            {% if alert.content.get('llm_found_indication') %}
                            <span class="badge badge-success">Found Indication</span>
                            {% if alert.content.get('llm_extracted_text') %}
                            <br><em>{{ alert.content.get('llm_extracted_text') }}</em>
                            {% endif %}
                            {% else %}
                            <span class="badge badge-secondary">No Indication Found</span>
                            {% endif %}
                        </dd>
                        {% endif %}

                        <dt>Recommendation</dt>
                        <dd class="recommendation-text">{{ alert.content.get('recommendation', '-')|replace(' Susceptibility', '')|replace(' susceptibility', '') }}</dd>
                    </dl>
                    {% else %}
                    {# Default display for other alert types #}
                    <dl>
                        {% for key, value in alert.content.items() %}
                        <dt>{{ key.replace('_', ' ').title() }}</dt>
                        <dd>
                            {% if key == 'coverage_status' %}
                                <span class="badge badge-coverage-{{ value|lower }}">{{ value|upper }}</span>
                            {% elif value is iterable and value is not string and value is not mapping %}
                                {{ value|join(', ') }}
                            {% else %}
                                {{ value }}
                            {% endif %}
                        </dd>
                        {% endfor %}
                    </dl>
                    {% endif %}
                </div>
                {% endif %}

                {% if alert.notes %}
                <div class="info-section">
                    <h3>Notes</h3>
                    <pre class="notes-content">{{ alert.notes }}</pre>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column: Actions -->
    <div class="alert-detail-sidebar">
        {% if alert.status.value != 'resolved' %}
        {% if alert.alert_type.value == 'bacteremia' and alert.source_id %}
        <div class="action-card">
            <h3>Clinical Data</h3>
            <div class="action-buttons-vertical">
                <a href="{{ url_for('asp_alerts.culture_detail', culture_id=alert.source_id) }}" class="btn btn-teal btn-block">View Culture Results</a>
                {% if alert.patient_id %}
                <a href="{{ url_for('asp_alerts.patient_medications', patient_id=alert.patient_id) }}" class="btn btn-teal btn-block">View Medications</a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="action-card resolve-card-highlight">
            <h3>Resolve Alert</h3>
            <form action="{{ url_for('api.resolve_alert', alert_id=alert.id) }}" method="post" class="resolve-form">
                <div class="form-group">
                    <label for="resolution_reason">Resolution Reason</label>
                    <select name="resolution_reason" id="resolution_reason" class="form-select" required>
                        <option value="">-- Select --</option>
                        {% for value, display in resolution_reasons %}
                        <option value="{{ value }}">{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="notes">Notes (optional)</label>
                    <textarea name="notes" id="notes" rows="3" class="form-textarea" placeholder="Add details..."></textarea>
                </div>

                <button type="submit" class="btn btn-success btn-block">Resolve Alert</button>
            </form>
        </div>

        <div class="action-card">
            <h3>Add Note</h3>
            <form action="{{ url_for('api.add_note', alert_id=alert.id) }}" method="post">
                <div class="form-group">
                    <textarea name="note" rows="2" class="form-textarea" placeholder="Enter a note..."></textarea>
                </div>
                <button type="submit" class="btn btn-block">Add Note</button>
            </form>
        </div>
        {% else %}
        <div class="action-card resolved-card">
            <h3>Resolution Details</h3>
            {% set resolution_items = [
                {'label': 'Resolved By', 'value': alert.resolved_by or 'Unknown'},
                {'label': 'Resolved At', 'value': alert.resolved_at.strftime('%Y-%m-%d %H:%M') if alert.resolved_at else '-'}
            ] %}
            {% if alert.resolution_reason %}
                {% set _ = resolution_items.append({'label': 'Reason', 'value': ResolutionReason.display_name(alert.resolution_reason)}) %}
            {% endif %}
            {% if alert.notes %}
                {% set _ = resolution_items.append({'label': 'Notes', 'value': '<pre class="notes-content-small">' ~ alert.notes ~ '</pre>', 'raw': true}) %}
            {% endif %}
            {{ detail_list(resolution_items) }}
        </div>
        {% endif %}
    </div>
</div>

{% if audit_log %}
<div class="audit-section">
    <h3>Audit Log</h3>
    <table class="audit-table">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Action</th>
                <th>User</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in audit_log %}
            <tr>
                <td>{{ entry.performed_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ entry.action.value }}</td>
                <td>{{ entry.performed_by or 'System' }}</td>
                <td>{{ entry.details or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
