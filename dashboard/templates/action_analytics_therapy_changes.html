{% extends "base.html" %}

{% block title %}Therapy Changes - Action Analytics - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Therapy Change Tracking</h1>
    <p class="page-description">Suggestion-to-change rate analysis across modules and units.</p>
</div>

{% if error is defined and error %}
<div class="alert alert-error">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

{# Filter bar #}
<form method="get" class="aa-filter-bar">
    <div class="aa-filter-group">
        <label for="filter-days">Period:</label>
        <select id="filter-days" name="days" onchange="this.form.submit()">
            {% for d in [7, 14, 30, 60, 90] %}
            <option value="{{ d }}" {% if days == d %}selected{% endif %}>Last {{ d }} days</option>
            {% endfor %}
        </select>
    </div>
    <div class="aa-filter-group">
        <a href="{{ url_for('action_analytics.dashboard') }}" class="btn btn-secondary btn-sm">Back to Dashboard</a>
        <a href="{{ url_for('action_analytics.export_therapy_csv', days=days) }}" class="btn btn-secondary btn-sm">Export CSV</a>
    </div>
</form>

{# Summary Stats #}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ therapy_data.get('total_suggestions', 0) }}</div>
        <div class="stat-label">Total Reviews/Interventions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ therapy_data.get('total_changes', 0) }}</div>
        <div class="stat-label">Therapy Changes</div>
    </div>
    <div class="stat-card {% if therapy_data.get('overall_change_rate', 0) >= 20 %}stat-good{% elif therapy_data.get('overall_change_rate', 0) >= 10 %}stat-warning{% endif %}">
        <div class="stat-value">{{ therapy_data.get('overall_change_rate', 0) }}%</div>
        <div class="stat-label">Overall Change Rate</div>
    </div>
</div>

{# By Module #}
<div class="dashboard-card">
    <h3>Therapy Change Rate by Module</h3>
    {% if therapy_data.get('by_module') %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Module</th>
                <th>Suggestions</th>
                <th>Changes</th>
                <th>Change Rate</th>
                <th>Visual</th>
            </tr>
        </thead>
        <tbody>
            {% for mod in therapy_data.by_module %}
            <tr>
                <td><strong>{{ mod.display_name }}</strong></td>
                <td>{{ mod.suggestions }}</td>
                <td>{{ mod.changes }}</td>
                <td>
                    <span class="rate-badge {% if mod.change_rate >= 20 %}rate-good{% elif mod.change_rate >= 10 %}rate-ok{% else %}rate-low{% endif %}">
                        {{ mod.change_rate }}%
                    </span>
                </td>
                <td>
                    <div class="breakdown-bar-container">
                        <div class="breakdown-bar breakdown-bar--therapy" style="width: {{ mod.change_rate }}%"></div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">No therapy change data available</p>
    {% endif %}
</div>

{# By Unit #}
{% if therapy_data.get('by_unit') %}
<div class="dashboard-card">
    <h3>Therapy Change Rate by Unit</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Unit</th>
                <th>Suggestions</th>
                <th>Changes</th>
                <th>Change Rate</th>
                <th>Visual</th>
            </tr>
        </thead>
        <tbody>
            {% for unit in therapy_data.by_unit %}
            <tr>
                <td><strong>{{ unit.unit }}</strong></td>
                <td>{{ unit.suggestions }}</td>
                <td>{{ unit.changes }}</td>
                <td>
                    <span class="rate-badge {% if unit.change_rate >= 20 %}rate-good{% elif unit.change_rate >= 10 %}rate-ok{% else %}rate-low{% endif %}">
                        {{ unit.change_rate }}%
                    </span>
                </td>
                <td>
                    <div class="breakdown-bar-container">
                        <div class="breakdown-bar breakdown-bar--therapy" style="width: {{ unit.change_rate }}%"></div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<style>
.aa-filter-bar { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
.aa-filter-group { display: flex; align-items: center; gap: 0.5rem; }
.aa-filter-group label { font-size: 0.875rem; font-weight: 500; color: #374151; }
.aa-filter-group select { padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; background: white; }
.btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
.page-description { color: #6b7280; font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 1rem; }
.stat-good { border-left: 4px solid #16a34a; }
.stat-warning { border-left: 4px solid #f59e0b; }
.breakdown-bar-container { height: 20px; background: #f3f4f6; border-radius: 4px; overflow: hidden; min-width: 150px; }
.breakdown-bar { height: 100%; border-radius: 4px; }
.breakdown-bar--therapy { background: linear-gradient(90deg, #059669 0%, #34d399 100%); }
.rate-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
.rate-good { background: #f0fdf4; color: #16a34a; }
.rate-ok { background: #fffbeb; color: #d97706; }
.rate-low { background: #fef2f2; color: #dc2626; }
.empty-state { text-align: center; color: #6b7280; padding: 2rem; }
</style>
{% endblock %}
