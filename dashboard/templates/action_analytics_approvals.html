{% extends "base.html" %}

{% block title %}Approval Analytics - Action Analytics - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Approval Workflow Analytics</h1>
    <p class="page-description">Antibiotic approval and denial rates, response times, and compliance tracking.</p>
</div>

{% if error is defined and error %}
<div class="alert alert-error">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

{# Filter bar #}
<form method="get" class="aa-filter-bar">
    <div class="aa-filter-group">
        <label for="filter-days">Period:</label>
        <select id="filter-days" name="days" onchange="this.form.submit()">
            {% for d in [7, 14, 30, 60, 90] %}
            <option value="{{ d }}" {% if days == d %}selected{% endif %}>Last {{ d }} days</option>
            {% endfor %}
        </select>
    </div>
    <div class="aa-filter-group">
        <a href="{{ url_for('action_analytics.dashboard') }}" class="btn btn-secondary btn-sm">Back to Dashboard</a>
    </div>
</form>

{% if approval_data.get('available') %}

{# Summary Stats #}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ approval_data.get('total_requests', 0) }}</div>
        <div class="stat-label">Total Requests</div>
        <div class="stat-sublabel">{% if approval_data.get('avg_requests_per_day') %}~{{ "%.1f"|format(approval_data.avg_requests_per_day) }}/day{% endif %}</div>
    </div>
    <div class="stat-card {% if approval_data.get('approval_rate') is not none and approval_data.approval_rate >= 70 %}stat-good{% endif %}">
        <div class="stat-value">{% if approval_data.get('approval_rate') is not none %}{{ approval_data.approval_rate }}%{% else %}--{% endif %}</div>
        <div class="stat-label">Approval Rate</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">
            {% if approval_data.get('response_times', {}).get('avg_minutes') is not none %}
                {% set avg = approval_data.response_times.avg_minutes %}
                {% if avg >= 60 %}{{ "%.1f"|format(avg / 60) }}h{% else %}{{ "%.0f"|format(avg) }}m{% endif %}
            {% else %}--{% endif %}
        </div>
        <div class="stat-label">Avg Response Time</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{% if approval_data.get('compliance_rate') is not none %}{{ approval_data.compliance_rate }}%{% else %}--{% endif %}</div>
        <div class="stat-label">Duration Compliance</div>
    </div>
</div>

{# Decision Breakdown #}
{% if approval_data.get('decision_breakdown') %}
<div class="dashboard-card">
    <h3>Decision Breakdown</h3>
    <div class="aa-decision-grid">
        {% for d in approval_data.decision_breakdown %}
        <div class="aa-decision-item">
            <span class="aa-decision-count">{{ d.count }}</span>
            <span class="aa-decision-label">{{ d.get('display', d.get('decision', 'Unknown')) }}</span>
            <span class="aa-decision-pct">{{ d.get('percentage', 0) }}%</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Top Antibiotics #}
{% if approval_data.get('top_antibiotics') %}
<div class="dashboard-card">
    <h3>Top Requested Antibiotics</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Antibiotic</th>
                <th>Requests</th>
                <th>Volume</th>
            </tr>
        </thead>
        <tbody>
            {% set max_count = approval_data.top_antibiotics[0].count if approval_data.top_antibiotics else 1 %}
            {% for abx in approval_data.top_antibiotics %}
            <tr>
                <td><strong>{{ abx.name }}</strong></td>
                <td>{{ abx.count }}</td>
                <td>
                    <div class="breakdown-bar-container">
                        <div class="breakdown-bar breakdown-bar--abx" style="width: {{ (abx.count / max_count * 100) | round }}%"></div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{# Re-approval Metrics #}
{% if approval_data.get('total_reapprovals', 0) > 0 %}
<div class="dashboard-card">
    <h3>Re-approval Tracking</h3>
    <div class="stats-grid" style="margin: 0;">
        <div class="stat-card">
            <div class="stat-value">{{ approval_data.total_reapprovals }}</div>
            <div class="stat-label">Re-approvals</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{% if approval_data.get('reapproval_rate') is not none %}{{ approval_data.reapproval_rate }}%{% else %}--{% endif %}</div>
            <div class="stat-label">Re-approval Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{% if approval_data.get('avg_approval_duration_hours') is not none %}{{ "%.0f"|format(approval_data.avg_approval_duration_hours) }}h{% else %}--{% endif %}</div>
            <div class="stat-label">Avg Approval Duration</div>
        </div>
    </div>
</div>
{% endif %}

{% else %}
{# ABX Approvals module not available #}
<div class="dashboard-card">
    <div class="empty-state">
        <h3>Approval Data Unavailable</h3>
        <p>{% if approval_data.get('error') %}{{ approval_data.error }}{% else %}The ABX Approvals module is not currently accessible.{% endif %}</p>
    </div>
</div>
{% endif %}

<style>
.aa-filter-bar { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
.aa-filter-group { display: flex; align-items: center; gap: 0.5rem; }
.aa-filter-group label { font-size: 0.875rem; font-weight: 500; color: #374151; }
.aa-filter-group select { padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; background: white; }
.btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
.page-description { color: #6b7280; font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 1rem; }
.stat-good { border-left: 4px solid #16a34a; }
.breakdown-bar-container { height: 20px; background: #f3f4f6; border-radius: 4px; overflow: hidden; min-width: 150px; }
.breakdown-bar { height: 100%; border-radius: 4px; }
.breakdown-bar--abx { background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); }
.aa-decision-grid { display: flex; flex-wrap: wrap; gap: 1rem; margin: 1rem 0; }
.aa-decision-item { text-align: center; flex: 1; min-width: 130px; padding: 1rem; border-radius: 8px; background: #f9fafb; border: 1px solid #e5e7eb; }
.aa-decision-count { display: block; font-size: 1.5rem; font-weight: bold; color: #0E7490; }
.aa-decision-label { display: block; font-size: 0.8125rem; color: #374151; margin-top: 0.25rem; }
.aa-decision-pct { display: block; font-size: 0.75rem; color: #9ca3af; }
.empty-state { text-align: center; color: #6b7280; padding: 2rem; }
</style>
{% endblock %}
