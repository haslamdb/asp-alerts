{% extends "base.html" %}

{% block title %}Help - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Demo Workflow Guide</h1>
</div>

<div class="help-content">
    <div class="help-card">
        <h2>Overview</h2>
        <p>This guide walks through generating and managing ASP alerts. The system monitors three scenarios:</p>
        <ol>
            <li><strong>Bacteremia Alert</strong> - Patient with positive blood culture lacking appropriate antibiotic coverage</li>
            <li><strong>Antimicrobial Usage Alert</strong> - Patient on broad-spectrum antibiotics exceeding the 72-hour threshold</li>
            <li><strong>No Indication Alert</strong> - Patient receiving antibiotics without documented indication (classification: "Never appropriate")</li>
        </ol>
    </div>

    <div class="help-card">
        <h2>Quick Start Commands</h2>

        <h3>1. Generate a Blood Culture Alert</h3>
        <p>Create a patient with a positive blood culture (MRSA) without appropriate coverage:</p>
        <pre><code>cd /home/david/projects/aegis
python scripts/demo_blood_culture.py --organism mrsa</code></pre>

        <p>Then run the bacteremia monitor to detect and alert:</p>
        <pre><code>cd asp-bacteremia-alerts
python -m src.monitor</code></pre>

        <h3>2. Generate an Antimicrobial Usage Alert</h3>
        <p>Create a patient on meropenem for 5 days (exceeds 72h threshold):</p>
        <pre><code>cd /home/david/projects/aegis
python scripts/demo_antimicrobial_usage.py --antibiotic meropenem --days 5</code></pre>

        <p>Then run the usage monitor:</p>
        <pre><code>cd antimicrobial-usage-alerts
python -m src.runner --once --verbose</code></pre>

        <h3>3. Generate a No Indication Alert</h3>
        <p>Create a patient with an antibiotic order but viral diagnosis (no indication for antibiotics):</p>
        <pre><code>cd /home/david/projects/aegis
python scripts/demo_indication_alert.py --scenario viral_with_abx</code></pre>

        <p>Then run the indication monitor:</p>
        <pre><code>cd antimicrobial-usage-alerts
python -m src.runner --indication --once --verbose</code></pre>
    </div>

    <div class="help-card">
        <h2>Blood Culture Scenarios</h2>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Command</th>
                    <th>Scenario</th>
                    <th>Alert?</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>--organism mrsa</code></td>
                    <td>MRSA, no antibiotic</td>
                    <td><span class="badge badge-critical">Yes</span></td>
                </tr>
                <tr>
                    <td><code>--organism mrsa --antibiotic vancomycin</code></td>
                    <td>MRSA with vancomycin</td>
                    <td><span class="badge badge-status-resolved">No</span></td>
                </tr>
                <tr>
                    <td><code>--organism mrsa --antibiotic cefazolin</code></td>
                    <td>MRSA with wrong antibiotic</td>
                    <td><span class="badge badge-critical">Yes</span></td>
                </tr>
                <tr>
                    <td><code>--organism pseudomonas</code></td>
                    <td>Pseudomonas, no coverage</td>
                    <td><span class="badge badge-critical">Yes</span></td>
                </tr>
                <tr>
                    <td><code>--organism pseudomonas --antibiotic meropenem</code></td>
                    <td>Pseudomonas with meropenem</td>
                    <td><span class="badge badge-status-resolved">No</span></td>
                </tr>
                <tr>
                    <td><code>--organism candida</code></td>
                    <td>Candida, no antifungal</td>
                    <td><span class="badge badge-critical">Yes</span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Antimicrobial Usage Scenarios</h2>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Command</th>
                    <th>Duration</th>
                    <th>Alert Level</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>--antibiotic meropenem --days 2</code></td>
                    <td>48 hours</td>
                    <td><span class="badge badge-status-resolved">None</span></td>
                </tr>
                <tr>
                    <td><code>--antibiotic meropenem --days 4</code></td>
                    <td>96 hours</td>
                    <td><span class="badge badge-warning">Warning</span></td>
                </tr>
                <tr>
                    <td><code>--antibiotic vancomycin --days 7</code></td>
                    <td>168 hours</td>
                    <td><span class="badge badge-critical">Critical</span></td>
                </tr>
                <tr>
                    <td><code>--antibiotic ceftriaxone --days 5</code></td>
                    <td>120 hours</td>
                    <td><span class="badge badge-status-resolved">None</span> (not monitored)</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Indication Monitoring Scenarios</h2>
        <p>The indication monitor classifies antibiotic orders using ICD-10 codes and clinical note extraction. Only "Never appropriate" (N) classifications generate alerts.</p>

        <h3>Demo Scenarios</h3>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Scenario</th>
                    <th>Description</th>
                    <th>Alert?</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>--scenario pneumonia</code></td>
                    <td>Bacterial pneumonia (ICD-10 + note)</td>
                    <td><span class="badge badge-status-resolved">No</span> (Always appropriate)</td>
                </tr>
                <tr>
                    <td><code>--scenario uti</code></td>
                    <td>Urinary tract infection</td>
                    <td><span class="badge badge-status-resolved">No</span> (Always appropriate)</td>
                </tr>
                <tr>
                    <td><code>--scenario viral_uri</code></td>
                    <td>Viral upper respiratory infection (no antibiotics)</td>
                    <td><span class="badge badge-status-resolved">No</span> (No antibiotics ordered)</td>
                </tr>
                <tr>
                    <td><code>--scenario viral_with_abx</code></td>
                    <td>Viral URI with unnecessary antibiotics</td>
                    <td><span class="badge badge-warning">Yes</span> (Never appropriate)</td>
                </tr>
                <tr>
                    <td><code>--scenario no_indication_documented</code></td>
                    <td>Antibiotics with no documented indication</td>
                    <td><span class="badge badge-warning">Yes</span> (Never appropriate)</td>
                </tr>
                <tr>
                    <td><code>--scenario note_contradicts_icd10</code></td>
                    <td>ICD-10 says pneumonia, note says viral</td>
                    <td><span class="badge badge-warning">Yes</span> (Note overrides ICD-10)</td>
                </tr>
            </tbody>
        </table>

        <h3>Classification Categories</h3>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Meaning</th>
                    <th>Alert?</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="badge badge-classification-A">A</span></td>
                    <td>Always appropriate for antibiotics</td>
                    <td>No</td>
                </tr>
                <tr>
                    <td><span class="badge badge-classification-S">S</span></td>
                    <td>Sometimes appropriate</td>
                    <td>No</td>
                </tr>
                <tr>
                    <td><span class="badge badge-classification-P">P</span></td>
                    <td>Prophylaxis appropriate</td>
                    <td>No</td>
                </tr>
                <tr>
                    <td><span class="badge badge-classification-N">N</span></td>
                    <td>Never appropriate</td>
                    <td><strong>Yes</strong></td>
                </tr>
            </tbody>
        </table>

        <h3>Two-Track Classification</h3>
        <p>The system uses two sources to determine if an antibiotic has an appropriate indication:</p>
        <ol>
            <li><strong>ICD-10 Classification</strong> - Uses Chua et al. pediatric antibiotic indication mappings</li>
            <li><strong>LLM Note Extraction</strong> - Extracts indications from clinical notes using a local LLM</li>
        </ol>
        <p><strong>Note Priority:</strong> Clinical notes take precedence over ICD-10 codes. If a note explicitly states "viral infection" but the patient has a pneumonia ICD-10 code, the system classifies as "N" (never appropriate) based on the note.</p>
    </div>

    <div class="help-card">
        <h2>Alert Resolution Workflow</h2>
        <ol>
            <li><strong>View</strong> - Click on an alert to see details</li>
            <li><strong>Acknowledge</strong> - Mark as seen (stays in active list)</li>
            <li><strong>Snooze 4h</strong> - Temporarily suppress the alert</li>
            <li><strong>Resolve</strong> - Close with a resolution reason:
                <ul>
                    <li>Acknowledged - No action needed</li>
                    <li>Messaged Team - Contacted the care team</li>
                    <li>Discussed with Team - Had discussion with providers</li>
                    <li>Therapy Changed - Antibiotic regimen was modified</li>
                    <li>Therapy Stopped - Antibiotic was discontinued</li>
                    <li>Patient Discharged - Patient left the hospital</li>
                </ul>
            </li>
        </ol>
        <p>Resolved alerts move to the <a href="{{ url_for('asp_alerts.alerts_history') }}">History</a> tab with a full audit trail.</p>
    </div>

    <div class="help-card">
        <h2>Interactive Demo Mode</h2>
        <p>For live demos where the audience can choose scenarios:</p>
        <pre><code># Blood culture - choose organism and antibiotic interactively
python scripts/demo_blood_culture.py --interactive

# Antimicrobial usage - choose drug and duration interactively
python scripts/demo_antimicrobial_usage.py --interactive</code></pre>
    </div>

    <div class="help-card">
        <h2>Troubleshooting</h2>

        <h3>FHIR server not responding</h3>
        <pre><code># Check if container is running
docker ps | grep hapi

# Restart if needed
cd asp-bacteremia-alerts
docker-compose down && docker-compose up -d</code></pre>

        <h3>Clear all data and start fresh</h3>
        <pre><code># Clear FHIR server data
cd asp-bacteremia-alerts
docker-compose down && docker-compose up -d

# Clear alert database
rm -f ~/.aegis/alerts.db</code></pre>

        <h3>Verify data was uploaded</h3>
        <pre><code>curl "http://localhost:8081/fhir/Patient?_count=5" | python -m json.tool</code></pre>
    </div>

    <div class="help-card">
        <h2>Architecture</h2>
        <pre class="architecture-diagram">
+-------------------+     +-------------------+
|   Demo Scripts    |----&gt;|  HAPI FHIR        |
|   (add patients)  |     |  Server :8081     |
+-------------------+     +---------+---------+
                                    |
         +--------------------------+--------------------------+
         v                          v                          v
+-------------------+    +-------------------+    +-------------------+
|   Bacteremia      |    |  Broad-Spectrum   |    |   Indication      |
|    Monitor        |    |  Usage Monitor    |    |    Monitor        |
+---------+---------+    +---------+---------+    +---------+---------+
         |                        |                        |
         |                        |               +--------+--------+
         |                        |               v                 v
         |                        |      +-------------+   +-------------+
         |                        |      | ICD-10      |   | LLM Note    |
         |                        |      | (Chua)      |   | Extraction  |
         |                        |      +------+------+   +------+------+
         |                        |             |                 |
         |                        |             +--------+--------+
         |                        |                      |
         +------------------------+----------------------+
                                  v
                        +-------------------+
                        |   Alert Store     |
                        |   (SQLite)        |
                        +---------+---------+
                                  |
                   +--------------+---------------+
                   v              v               v
          +-----------+   +-----------+   +-----------+
          | Dashboard |   |   Teams   |   |   Email   |
          +-----------+   +-----------+   +-----------+
        </pre>
    </div>
</div>
{% endblock %}
